#!/usr/bin/env ruby

require 'json'
require 'httparty'

example = ARGV[0]
path    = "examples/#{example}"

host    = 'localhost'
port    = '9200'
index   = 'elasticsearch-by-example'
type    = 'example'

base    = "http://#{host}:#{port}"

# Show info
# Todo: enable/disable info with command line parameter.
puts "\n"
puts "Information:"
puts File.read("#{path}/info.md")
puts "\n"

# Index documents
docs = JSON.parse(File.read("#{path}/docs.json"))
docs.each_with_index do |doc, i|
  HTTParty.put("#{base}/#{index}/#{type}/#{i}", {:body => doc.to_json})
end

# Refresh index
HTTParty.post("#{base}/#{index}/_refresh")

# Query index
query = File.read("#{path}/query.json")
response = HTTParty.post("#{base}/#{index}/#{type}/_search", {:body => query})
# Todo: show results
puts "Response:\n"
puts "#{response.parsed_response["hits"]["total"]} hits"

# Remove index
HTTParty.delete("#{base}/#{index}")
